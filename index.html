<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWS Sales System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 100px;
            background-color: #f4f4f4;
            padding: 10px 0;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar button {
            display: block;
            width: 90px;
            padding: 8px;
            margin: 5px auto;
            font-size: 14px;
            background-color: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar button:hover {
            background-color: #005bb5;
        }
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .section {
            margin-bottom: 30px;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        input, button, select {
            padding: 8px;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            cursor: pointer;
        }
        th {
            background-color: #f2f2f2;
            position: relative;
        }
        th:hover {
            background-color: #e0e0e0;
        }
        .sort-arrow {
            display: inline-block;
            margin-left: 5px;
            font-size: 12px;
        }
        .hidden {
            display: none;
        }
        .no-data {
            color: #ff4444;
            font-weight: bold;
            margin-top: 10px;
        }
        .home-section {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .home-title {
            font-size: 48px;
            color: #0066cc;
            background-color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
        }
        .update-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .edit-form {
            display: none;
            margin-top: 10px;
            flex-direction: column;
            gap: 10px;
        }
        .delete-btn {
            background-color: #ff4444;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        @media (max-width: 600px) {
            .sidebar {
                width: 80px;
            }
            .sidebar button {
                width: 70px;
                font-size: 12px;
                padding: 6px;
            }
            .content {
                padding: 10px;
            }
            input, button, select {
                width: 100%;
                margin-bottom: 10px;
            }
            table, th, td {
                font-size: 12px;
            }
            .home-title {
                font-size: 24px;
                padding: 10px;
            }
            .sort-arrow {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button onclick="showSection('home')">首页</button>
        <button onclick="showSection('memo')">备忘事项</button>
        <button onclick="showSection('storeSearch')">门店搜索</button>
        <button onclick="showSection('tileUpload')">瓷砖上传</button>
        <button onclick="showSection('storeUpload')">门店上传</button>
    </div>

    <div class="content">
        <!-- 首页 -->
        <div id="homeSection" class="section">
            <div class="home-section">
                <h1 class="home-title">OWS Sales System</h1>
            </div>
        </div>

        <!-- 备忘事项 -->
        <div id="memoSection" class="section hidden">
            <h2>备忘事项</h2>
            <div class="update-box">
                <button onclick="toggleMemoForm()">新增</button>
                <button class="delete-btn" onclick="deleteSelectedMemos()">删除</button>
            </div>
            <div id="memoForm" class="edit-form">
                <input type="date" id="memoDate">
                <input type="text" id="memoContent" placeholder="请输入备忘事项">
                <button onclick="addMemo()">保存</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllMemos" onclick="toggleSelectAllMemos()"></th>
                        <th>日期</th>
                        <th>备忘事项</th>
                    </tr>
                </thead>
                <tbody id="memoTableBody">
                    <!-- 动态填充 -->
                </tbody>
            </table>
        </div>

        <!-- 门店搜索 -->
        <div id="storeSearchSection" class="section hidden">
            <h2>门店搜索</h2>
            <div class="search-box">
                <select id="salesmanFilter" onchange="filterStores()">
                    <option value="">所有销售人员</option>
                    <!-- 动态填充 -->
                </select>
                <input type="text" id="storeSearch" placeholder="输入门店名称搜索..." oninput="searchStores()">
                <button onclick="searchStores()">搜索</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('salesman')">销售人员<span class="sort-arrow" id="sortSalesmanArrow"></span></th>
                        <th onclick="sortTable('name')">门店名称<span class="sort-arrow" id="sortNameArrow"></span></th>
                        <th onclick="sortTable('address')">地址</th>
                        <th onclick="sortTable('region')">区域<span class="sort-arrow" id="sortRegionArrow"></span></th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="storeTableBody">
                    <!-- 动态填充 -->
                </tbody>
            </table>
        </div>

        <!-- 瓷砖上传 -->
        <div id="tileUploadSection" class="section hidden">
            <h2>瓷砖上传</h2>
            <input type="file" id="tileFile" accept=".xlsx" onchange="uploadTiles()">
            <p>请上传 Excel 文件（包含列：SIZE (MM), ITEM CODE, ITEM NAME, DESCRIPTION）</p>
        </div>

        <!-- 门店上传 -->
        <div id="storeUploadSection" class="section hidden">
            <h2>门店上传</h2>
            <input type="file" id="storeFile" accept=".xlsx" onchange="uploadStores()">
            <p>请上传 Excel 文件（包含列：name, address, region, salesman, salesAmount 或中文列名如 门店名称、地址等）</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 从 localStorage 获取数据
        let stores = JSON.parse(localStorage.getItem("stores")) || [
            { id: 1, name: "LOCKWOOD CARPETS", address: "123 Main St", region: "North", salesman: "Jane", salesAmount: 5000 },
            { id: 2, name: "H&Y TILES", address: "456 Oak Ave", region: "South", salesman: "Bob", salesAmount: 7500 },
            { id: 3, name: "TOUCH SURFAC", address: "789 Pine Rd", region: "East", salesman: "Sara", salesAmount: 3000 },
            { id: 4, name: "SYDNEY TAPS", address: "321 Elm St", region: "West", salesman: "Lisa", salesAmount: 6000 },
            { id: 5, name: "SOUL BATHROC", address: "654 Birch Ln", region: "North", salesman: "David", salesAmount: 4000 },
            { id: 6, name: "DESINO TILES A BATHWARE", address: "987 Cedar Dr", region: "South", salesman: "James", salesAmount: 8000 },
            { id: 7, name: "TEMPE TILE CENTRE", address: "147 Maple Blvd", region: "East", salesman: "Chris", salesAmount: 5500 }
        ];
        let tiles = JSON.parse(localStorage.getItem("tiles")) || [];
        let memos = JSON.parse(localStorage.getItem("memos")) || [];

        // 保存初始数据到 localStorage（如果为空）
        if (!localStorage.getItem("stores")) {
            localStorage.setItem("stores", JSON.stringify(stores));
        }
        if (!localStorage.getItem("memos")) {
            localStorage.setItem("memos", JSON.stringify(memos));
        }

        // 排序状态
        let sortConfig = {
            key: null,
            direction: 'asc'
        };

        // 填充销售人员下拉菜单
        function populateSalesmanFilter() {
            console.log("Populating salesman filter...");
            const salesmanFilter = document.getElementById("salesmanFilter");
            const uniqueSalesmen = [...new Set(stores.map(store => store.salesman || "N/A"))];
            salesmanFilter.innerHTML = '<option value="">所有销售人员</option>';
            uniqueSalesmen.forEach(salesman => {
                salesmanFilter.innerHTML += `<option value="${salesman}">${salesman}</option>`;
            });
        }

        // 渲染门店表格
        function renderStoreTable(filteredStores = stores) {
            console.log("Rendering store table with stores:", filteredStores);
            const tbody = document.getElementById("storeTableBody");
            tbody.innerHTML = "";

            // 应用排序
            if (sortConfig.key) {
                filteredStores.sort((a, b) => {
                    let valueA = a[sortConfig.key] || '';
                    let valueB = b[sortConfig.key] || '';
                    if (typeof valueA === 'string') valueA = valueA.toLowerCase();
                    if (typeof valueB === 'string') valueB = valueB.toLowerCase();
                    if (valueA < valueB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valueA > valueB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            if (filteredStores.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="no-data">未找到门店，请在“门店上传”中添加数据！</td></tr>`;
                return;
            }
            filteredStores.forEach(store => {
                const name = store.name || "未知门店";
                const address = store.address || "未知地址";
                const region = store.region || "未知区域";
                const salesman = store.salesman || "未知销售人员";
                tbody.innerHTML += `<tr>
                    <td>${salesman}</td>
                    <td>${name}</td>
                    <td>${address}</td>
                    <td>${region}</td>
                    <td><button onclick="viewStoreDetail(${store.id})">查看详情</button></td>
                </tr>`;
            });

            // 更新箭头显示
            updateSortArrows();
        }

        // 排序表格
        function sortTable(key) {
            console.log("Sorting table by:", key);
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            const query = document.getElementById("storeSearch").value.trim().toLowerCase();
            const salesmanFilter = document.getElementById("salesmanFilter").value;
            let filteredStores = stores;

            if (salesmanFilter) {
                filteredStores = filteredStores.filter(store => store.salesman === salesmanFilter);
            }
            if (query) {
                filteredStores = filteredStores.filter(store =>
                    (store.name && store.name.toLowerCase().includes(query)) ||
                    (store.address && store.address.toLowerCase().includes(query)) ||
                    (store.region && store.region.toLowerCase().includes(query))
                );
            }
            renderStoreTable(filteredStores);
        }

        // 更新排序箭头
        function updateSortArrows() {
            const arrows = {
                salesman: document.getElementById("sortSalesmanArrow"),
                name: document.getElementById("sortNameArrow"),
                region: document.getElementById("sortRegionArrow")
            };
            for (let key in arrows) {
                arrows[key].textContent = '';
            }
            if (sortConfig.key) {
                arrows[sortConfig.key].textContent = sortConfig.direction === 'asc' ? '↑' : '↓';
            }
        }

        // 搜索和过滤门店
        function searchStores() {
            console.log("Searching stores...");
            const query = document.getElementById("storeSearch").value.trim().toLowerCase();
            const salesmanFilter = document.getElementById("salesmanFilter").value;
            let filteredStores = stores;

            if (salesmanFilter) {
                filteredStores = filteredStores.filter(store => store.salesman === salesmanFilter);
            }
            if (query) {
                filteredStores = filteredStores.filter(store =>
                    (store.name && store.name.toLowerCase().includes(query)) ||
                    (store.address && store.address.toLowerCase().includes(query)) ||
                    (store.region && region.toLowerCase().includes(query))
                );
            }
            renderStoreTable(filteredStores);
        }

        // 过滤门店（由下拉菜单触发）
        function filterStores() {
            console.log("Filtering stores by salesman...");
            searchStores();
        }

        // 查看门店详情
        function viewStoreDetail(storeId) {
            console.log("Viewing store detail for ID:", storeId);
            window.location.href = `store-detail.html?id=${storeId}`;
        }

        // 上传瓷砖资料
        function uploadTiles() {
            console.log("Uploading tiles...");
            const fileInput = document.getElementById("tileFile");
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    tiles = XLSX.utils.sheet_to_json(worksheet).map(tile => {
                        return {
                            size: tile["SIZE (MM)"] || tile.size || "",
                            itemCode: tile["ITEM CODE"] || tile.itemCode || "",
                            itemName: tile["ITEM NAME"] || tile.itemName || "",
                            description: tile["DESCRIPTION"] || tile.description || ""
                        };
                    });
                    console.log("Uploaded tiles:", tiles);
                    localStorage.setItem("tiles", JSON.stringify(tiles));
                    alert("瓷砖上传成功！");
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert("请选择一个 Excel 文件！");
            }
        }

        // 上传门店资料
        function uploadStores() {
            console.log("Uploading stores...");
            const fileInput = document.getElementById("storeFile");
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    stores = XLSX.utils.sheet_to_json(worksheet).map((store, index) => {
                        return {
                            id: index + 1,
                            name: store.name || store["门店名称"] || store["Name"] || "未知门店",
                            address: store.address || store["地址"] || store["Address"] || "未知地址",
                            region: store.region || store["区域"] || store["Region"] || "未知区域",
                            salesman: store.salesman || store["销售人员"] || store["Salesman"] || "未知销售人员",
                            salesAmount: parseFloat(store.salesAmount || store["销售金额"] || store["SalesAmount"] || 0)
                        };
                    });
                    console.log("Uploaded stores:", stores);
                    localStorage.setItem("stores", JSON.stringify(stores));
                    renderStoreTable();
                    populateSalesmanFilter();
                    alert("门店上传成功！");
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert("请选择一个 Excel 文件！");
            }
        }

        // 切换备忘录表单
        function toggleMemoForm() {
            console.log("Toggling memo form...");
            const form = document.getElementById("memoForm");
            form.style.display = form.style.display === "flex" ? "none" : "flex";
            if (form.style.display === "flex") {
                const today = new Date().toISOString().split("T")[0];
                document.getElementById("memoDate").value = today;
                document.getElementById("memoContent").value = "";
            }
        }

        // 新增备忘录
        function addMemo() {
            console.log("Adding memo...");
            const date = document.getElementById("memoDate").value;
            const content = document.getElementById("memoContent").value.trim();

            if (!date) {
                alert("请选择日期！");
                return;
            }
            if (!content) {
                alert("请输入备忘事项！");
                return;
            }

            const newMemo = {
                date: date,
                content: content
            };
            memos.push(newMemo);
            localStorage.setItem("memos", JSON.stringify(memos));

            renderMemos();
            toggleMemoForm();
            alert("备忘录添加成功！");
        }

        // 全选/取消全选备忘录
        function toggleSelectAllMemos() {
            console.log("Toggling select all memos...");
            const selectAllCheckbox = document.getElementById("selectAllMemos");
            const checkboxes = document.querySelectorAll("input[name='memoCheck']");
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // 批量删除选中的备忘录
        function deleteSelectedMemos() {
            console.log("Deleting selected memos...");
            const checkedMemos = Array.from(document.querySelectorAll("input[name='memoCheck']:checked"));
            if (checkedMemos.length === 0) {
                alert("请至少选择一个备忘录进行删除！");
                return;
            }
            if (confirm(`确定要删除 ${checkedMemos.length} 个备忘录吗？`)) {
                const indicesToDelete = checkedMemos.map(checkbox => parseInt(checkbox.value)).sort((a, b) => b - a);
                indicesToDelete.forEach(index => {
                    memos.splice(index, 1);
                });

                localStorage.setItem("memos", JSON.stringify(memos));
                renderMemos();
                document.getElementById("selectAllMemos").checked = false;
                alert("备忘录删除成功！");
            }
        }

        // 渲染备忘录
        function renderMemos() {
            console.log("Rendering memos:", memos);
            const memoTableBody = document.getElementById("memoTableBody");
            memoTableBody.innerHTML = "";
            memos.forEach((memo, index) => {
                memoTableBody.innerHTML += `<tr>
                    <td><input type="checkbox" name="memoCheck" value="${index}"></td>
                    <td>${memo.date}</td>
                    <td>${memo.content}</td>
                </tr>`;
            });
            if (memos.length === 0) {
                memoTableBody.innerHTML = `<tr><td colspan="3" class="no-data">暂无备忘事项，请点击“新增”添加！</td></tr>`;
            }
        }

        // 显示指定功能区域
        function showSection(section) {
            console.log("Showing section:", section);
            const homeSection = document.getElementById("homeSection");
            const memoSection = document.getElementById("memoSection");
            const storeSearchSection = document.getElementById("storeSearchSection");
            const tileUploadSection = document.getElementById("tileUploadSection");
            const storeUploadSection = document.getElementById("storeUploadSection");

            // 隐藏所有页面
            homeSection.classList.add("hidden");
            memoSection.classList.add("hidden");
            storeSearchSection.classList.add("hidden");
            tileUploadSection.classList.add("hidden");
            storeUploadSection.classList.add("hidden");

            // 显示目标页面并触发相关逻辑
            if (section === "home") {
                homeSection.classList.remove("hidden");
            } else if (section === "memo") {
                memoSection.classList.remove("hidden");
                renderMemos();
            } else if (section === "storeSearch") {
                storeSearchSection.classList.remove("hidden");
                populateSalesmanFilter();
                renderStoreTable();
            } else if (section === "tileUpload") {
                tileUploadSection.classList.remove("hidden");
            } else if (section === "storeUpload") {
                storeUploadSection.classList.remove("hidden");
            }
        }

        // 初始化，默认显示首页
        window.onload = function() {
            console.log("Page loaded, showing home section...");
            showSection("home");
        };
    </script>
</body>
</html>